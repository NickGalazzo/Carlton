@using MediatR
@using Carlton.Base.Infrastructure.Client.Data
@using Carlton.Base.Infrastructure.Client.Events
@using Microsoft.AspNetCore.Components

@namespace Carlton.Base.Infrastructure.Client.Components.Data
@typeparam TViewModel

<div class="carlton-data-wrapper">
    @ChildComponent(Context)
</div>


@code{
    [Parameter]
    public RenderFragment<ComponentDataWrapperContext<TViewModel>> ChildComponent { get; set; }

    [Inject]
    private IDataService<TViewModel> DataService { get; set; }

    [Inject]
    private IMediator Mediatr { get; set; }

    private ComponentDataWrapperContext<TViewModel> Context { get; set; }
    private TViewModel ViewModel { get; set; }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        ViewModel = DataService.GetViewModel();
        Context = new ComponentDataWrapperContext<TViewModel>(ViewModel, ComponentEventHandler);
        DataService.ViewModelChanged += DataService_ViewModelChanged;
    }

    private void DataService_ViewModelChanged(object sender, ViewModelChangedEventArgs e)
    {
        ViewModel = DataService.GetViewModel();
    }


    public async Task ComponentEventHandler(IComponentEvent<IComponentEventResult> evt)
    {
        await Mediatr.Send(evt);
    }
}